Applet which uses cflow pointcut gets AccessControlException
When I used cflow pointcut for my applet, I couldn't launch the Applet.
java.lang.ExceptionInInitializerError
at SandAspect.ajc$preClinit(SandAspect.aj)
at SandAspect.<clinit>(SandAspect.aj)
at SandApplet.init(SandApplet.java)
at sun.applet.AppletPanel.run(AppletPanel.java:353)
at java.lang.Thread.run(Thread.java:534)
Caused by: java.security.AccessControlException: access denied (java.util.Proper
tyPermission aspectj.runtime.cflowstack.usethreadlocal read)
at java.security.AccessControlContext.checkPermission(AccessControlConte
xt.java:269)
at java.security.AccessController.checkPermission(AccessController.java:
401)
at java.lang.SecurityManager.checkPermission(SecurityManager.java:524)
at java.lang.SecurityManager.checkPropertyAccess(SecurityManager.java:12
76)
at java.lang.System.getProperty(System.java:612)
at org.aspectj.runtime.internal.CFlowStack.selectFactoryForVMVersion(CFl
owStack.java:124)
at org.aspectj.runtime.internal.CFlowStack.<clinit>(CFlowStack.java:59)
... 5 more
It because CFlowStack uses System.getProperty method with no try..catch block.
Applet doesn't have permission to read system property:
"aspectj.runtime.cflowstack.usethreadlocal".
workaround:
modify CFlowStack.java(1.5) line 123,124 like this
-----
private static String getSystemPropertyWithNoSecurityException(
String aPropertyName, String aDefaultValue){
try{
return System.getProperty(aPropertyName, aDefaultValue);
} catch(java.lang.SecurityException e){
return aDefaultValue;
}
}
private static void selectFactoryForVMVersion() {
String override = getSystemPropertyWithNoSecurityException(
"aspectj.runtime.cflowstack.usethreadlocal"
, "unspecified"
);
-----
I think defining getSystemPropertyWithNoSecurityException(or more
simple name :-)) method in some utility class and using it where you call
System.getProperty are better way.