53993 – NPE in AccessLogValve
During a load test of tomcat 7.0.30, we occasionally see NPEs from the AccessLogValve.
 Some of the requests that are being executed as part of the load test call HttpSession.invalidate.
 I mention this because the code in question appears to be susceptible to multithreaded manipulation of the session.
 I think the fix should be as simple as a check for null on the return value of request.getSessionInternal.
Of course, our access log pattern includes logging the session id.
java.lang.NullPointerException
org.â€‹apache.â€‹catalina.â€‹valves.â€‹AccessLogValve$â€‹SessionIdElement.â€‹addElement(â€‹AccessLogValve.java:1733)
org.apache.catalina.valves.AccessLogValve.log(AccessLogValve.java:955)
org.apache.catalina.core.AccessLogAdapter.log(AccessLogAdapter.java:51)
org.apache.catalina.core.StandardEngine.logAccess(StandardEngine.java:332)
org.apache.catalina.core.ContainerBase.logAccess(ContainerBase.java:1270)
org.apache.catalina.core.ContainerBase.logAccess(ContainerBase.java:1270)
org.apache.catalina.connector.CoyoteAdapter.service(CoyoteAdapter.java:441)
org.â€‹apache.â€‹coyote.â€‹http11.â€‹AbstractHttp11Processor.â€‹process(â€‹AbstractHttp11Processor.java:1002)
org.â€‹apache.â€‹coyote.â€‹AbstractProtocol$â€‹AbstractConnectionHandler.â€‹process(â€‹AbstractProtocol.java:585)
org.â€‹apache.â€‹tomcat.â€‹util.â€‹net.â€‹JIoEndpoint$â€‹SocketProcessor.â€‹run(â€‹JIoEndpoint.â€‹java:â€‹312)â€‹
java.util.concurrent.ThreadPoolExecutor.runWorker(ThreadPoolExecutor.java:1110)
java.util.concurrent.ThreadPoolExecutor$Worker.run(ThreadPoolExecutor.java:603)
java.lang.Thread.run(Thread.java:722)
existing code for convenience:
protected static class SessionIdElement implements AccessLogElement {
@Override
public void addElement(StringBuilder buf, Date date, Request request,
Response response, long time) {
if (request != null) {
if (request.getSession(false) != null) {
buf.append(request.getSessionInternal(false) // LINE 1733
.getIdInternal());
} else {
buf.append('-');
}
} else {
buf.append('-');
}
}
}
possible fix:
...
if (request.getSession(false) != null) {
Session internalSession = request.getSessionInternal(false);
if (internalSession != null) {
buf.append(internalSession.getIdInternal());
} else {
buf.append('-');
}
} else {
buf.append('-');
}